homematic:
  interfaces:
    rf:
      host: !secret homematic-host
      username: !secret homematic-user
      password: !secret homematic-password
      port: 2001
      resolvenames: json
    ip:
      host: !secret homematic-host
      username: !secret homematic-user
      password: !secret homematic-password
      port: 2010
      resolvenames: json
    groups:
      host: !secret homematic-host
      username: !secret homematic-user
      password: !secret homematic-password
      port: 9292
      resolvenames: json
      path: /groups
  hosts:
    central:
      host: !secret homematic-host
      username: !secret homematic-user
      password: !secret homematic-password

timer:
  homematic_watchdog_timeout:
    name: "Homematic Watchdog: Timeout"
    duration: "00:10:00"

sensor:
  - platform: template
    sensors:
      homematic_last_reboot:
        friendly_name: "letzter Neustart (Homematic)"
        value_template: "{{ strptime(state_attr('homematic.central', 'last_reboot') or '1970-01-01 00:00:00', '%Y-%m-%d %H:%M:%S').isoformat() }}"
        device_class: "timestamp"
        icon_template: "mdi:clock"
      dwd_hourly_forecast_index:
        friendly_name: "DWD Hourly Forecast Index"
        value_template: "{{ (((utcnow() - state_attr('weather.dwd_weather_frankfurt_m_1h', 'forecast_time_utc')).total_seconds() // 3600) - 1) | int }}"
      dwd_hourly_last_updated:
        friendly_name: "DWD Hourly Last Updated"
        value_template: "{{ state_attr('weather.dwd_weather_frankfurt_m_1h', 'forecast_time_utc') }}"
        device_class: "timestamp"
        icon_template: "mdi:clock"
      openweathermap_last_updated:
        friendly_name: "OpenWeatherMap Last Updated"
        value_template: "{{ states.weather.openweathermap.last_updated.isoformat() }}"
        device_class: "timestamp"
        icon_template: "mdi:clock"
      sun_azimuth:
        friendly_name: "Sonnenstand (Azimuth)"
        unit_of_measurement: "°"
        value_template: "{{ state_attr('homematic.central', 'sun_azimuth') | round(2) }}"
        icon_template: "mdi:weather-sunny"
      sun_elevation:
        friendly_name: "Sonnenstand (Höhe)"
        unit_of_measurement: "°"
        value_template: "{{ state_attr('homematic.central', 'sun_elevation') | round(2) }}"
        icon_template: "mdi:weather-sunny"

automation:
  - alias: Homematic Watchdog
    trigger:
      - platform: homeassistant
        event: start
      - platform: event # Homematic keepalive at periods < timer.homematic_watchdog_timeout.duration
        event_type: homematic.keypress
        event_data:
          name: HM-RCV-50 BidCoS-RF
          channel: 1
          param: PRESS_SHORT
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.homematic_watchdog_timeout
    action:
      - service: timer.start
        entity_id: timer.homematic_watchdog_timeout
      - condition: and
        conditions: "{{ trigger.event.event_type == 'timer.finished' }}"
      - service: homematic.reconnect
      - service: notify.telegram_admin
        data:
          message: "Homematic dead. Attempting to reconnect ..."

  - alias: Update Weather on Homematic
    trigger:
      - platform: state
        entity_id: sensor.openweathermap_last_updated
      - platform: state
        entity_id: sensor.dwd_hourly_last_updated
    action:
      - delay: "00:00:05"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_cloud_coverage"
          value: "{{ states('sensor.openweathermap_cloud_coverage') | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_forecast_precipitation"
          value: "{{ state_attr('weather.dwd_weather_frankfurt_m_1h', 'forecast')[0]['precipitation'] | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_forecast_wind_gusts"
          value: "{{ state_attr('sensor.wind_gusts_frankfurt_m_1h', 'data')[states('sensor.dwd_hourly_forecast_index') | int]['value'] | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_humidity"
          value: "{{ states('sensor.openweathermap_humidity') | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_pressure"
          value: "{{ states('sensor.openweathermap_pressure') | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_temperature"
          value: "{{ states('sensor.openweathermap_temperature') | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_wind_bearing"
          value: "{{ states('sensor.openweathermap_wind_bearing') | float }}"
      - service: homematic.set_variable_value
        target:
          entity_id: homematic.central
        data:
          name: "weather_wind_speed"
          value: "{{ states('sensor.openweathermap_wind_speed') | float }}"

homeassistant:
  customize:
    sensor.0001dbe9a628d5_current:
      friendly_name: Schalt-/Mess-Steckdose USV (Strom)
    sensor.0001dbe9a628d5_energy_counter:
      friendly_name: Schalt-/Mess-Steckdose USV (Energieverbrauch)
    sensor.0001dbe9a628d5_frequency:
      friendly_name: Schalt-/Mess-Steckdose USV (Frequenz)
    sensor.0001dbe9a628d5_power:
      friendly_name: Schalt-/Mess-Steckdose USV (Leistung)
    sensor.0001dbe9a628d5_voltage:
      friendly_name: Schalt-/Mess-Steckdose USV (Spannung)
    switch.0001dbe9a628d5:
      friendly_name: Schalt-/Mess-Steckdose USV

