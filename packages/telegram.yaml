telegram_bot:
  - platform: polling
    api_key: !secret telegram-api-key
    allowed_chat_ids: !secret telegram-allowed-chat-ids

notify:
  - name: telegram_admin
    platform: telegram
    chat_id: !secret telegram-chat-id-admin

alert:
  certificate_expiry:
    name: Certificate expiry close
    message: >
      *Certificate expiry close* (valid for {{ states('sensor.cert_expiry_days_left') | int(0) }} days). Check renewal routine!
    done_message: >
      Certificate renewed.
    entity_id: binary_sensor.cert_expiry_close
    skip_first: true
    repeat:
      - 60
      - 2880
    notifiers:
      - telegram_admin
  storm:
    name: Storm alert
    message: >
      *Storm alert* (wind speed {{ states('sensor.weather_wind_speed_max_recent') | int(0) }} m/s). Check marquee ({{ states('cover.roller_shutter_markise') }}), windows, and blinds!
    done_message: >
      Storm alert deactivated.
    entity_id: binary_sensor.weather_storm
    skip_first: true
    repeat:
      - 1
      - 60
      - 480
    can_acknowledge: true
    data:
      inline_keyboard:
        - "Close marquee:/close_marquee, Acknowledge:/storm_acknowledge"
    notifiers:
      - telegram_admin

automation:
  - alias: "Telegram callback to acknowledge storm alerts"
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          data: "/storm_acknowledge"
    action:
      - service: alert.turn_off
        target:
          entity_id: alert.storm
  - alias: "Telegram callback to close marquee"
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          data: "/close_marquee"
    action:
      - service: cover.close_cover
        target:
          entity_id: cover.roller_shutter_markise
