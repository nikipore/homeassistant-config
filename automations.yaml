- alias: Perform Daily Backup
  trigger:
    - platform: time
      at: "04:00:00"
  action:
    - service: auto_backup.snapshot_full
      data:
        name: "Daily Backup: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        keep_days: 14

- alias: "Homematic Watchdog"
  trigger:
    - platform: homeassistant
      event: start
    - platform: event # Homematic keepalive at periods < timer.homematic_watchdog_timeout.duration
      event_type: homematic.keypress
      event_data:
        name: HM-RCV-50 BidCoS-RF
        channel: 1
        param: PRESS_SHORT
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.homematic_watchdog_timeout
  action:
    - service: timer.start
      entity_id: timer.homematic_watchdog_timeout
    - condition: and
      conditions: "{{ trigger.event.event_type == 'timer.finished' }}"
    - service: homematic.reconnect
    - service: notify.telegram_admin
      data:
        message: "Homematic dead. Attempting to reconnect ..."

- alias: Update OpenWeatherMap on Homematic
  trigger:
    platform: state
    entity_id: sensor.openweathermap_last_updated
  action:
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_cloud_coverage"
        value: "{{ states('sensor.openweathermap_cloud_coverage') | float }}"
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_humidity"
        value: "{{ states('sensor.openweathermap_humidity') | float }}"
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_pressure"
        value: "{{ states('sensor.openweathermap_pressure') | float }}"
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_rain"
        value: "{{ states('sensor.openweathermap_rain') | float }}"
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_temperature"
        value: "{{ states('sensor.openweathermap_temperature') | float }}"
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_wind_bearing"
        value: "{{ states('sensor.openweathermap_wind_bearing') | float }}"
    - service: homematic.set_variable_value
      target:
        entity_id: homematic.central
      data:
        name: "openweathermap_wind_speed"
        value: "{{ states('sensor.openweathermap_wind_speed') | float }}"
