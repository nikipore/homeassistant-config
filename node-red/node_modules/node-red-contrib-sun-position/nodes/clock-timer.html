<!DOCTYPE HTML>

<script type="text/javascript">
    (function() {
        RED.nodes.registerType('clock-timer', {
            category: 'time and astro',
            color: '#FFCC66',
            icon: 'clock-timer-white.svg',
            inputs: 1,
            outputs: 1,
            defaults: {
                name: {
                    value: '',
                    required: false
                },
                topic: {
                    value: '',
                    required: false
                },
                positionConfig: {
                    value: '',
                    type: 'position-config',
                    required: true
                },
                outputs: { value: '1' },
                autoTrigger: { value: false },
                autoTriggerTime: {
                    value: 20 * 60000,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (RED.validators.number()(v) && (n >= 60000) && (n < 0x7FFFFFFF));
                    }
                },
                startDelayTime: {
                    value: 10000,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (RED.validators.number()(v) && (n >= 0) && (n < 0x7FFFFFFF));
                    }
                },
                storeName:  { value: '' },
                // #region overwrite settings
                overwriteExpire: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (v === '') ||
                               (RED.validators.number()(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }
                },
                // #endregion overwrite settings
                // #region rule settings
                rules: {
                    value: {}
                },
                payloadDefault: {
                    value: '',
                    validate: RED.validators.typedInput('payloadDefaultType')
                },
                payloadDefaultType: {
                    value: 'none'
                },
                payloadDefaultTimeFormat: {
                    value: 0
                },
                payloadDefaultOffset: {
                    value: 0,
                    validate(v) {
                        return (
                            (typeof v === 'undefined') ||
                            (typeof this.payloadOffsetType === 'undefined') ||
                            RED.validators.typedInput('payloadOffsetType')(v)
                        );
                    }
                },
                payloadDefaultOffsetType: {
                    value: 'none'
                },
                payloadDefaultOffsetMultiplier: {
                    value: 60000,
                    validate : RED.validators.number()
                }
                // #endregion time settings
            },
            outputLabels() {
                return [this._('clock-timer.label.output1'), this._('clock-timer.label.output2')];
            },
            label() {
                let suffix = '';
                if (this.rules && (this.rules.length >0)) {
                    suffix += '‚è≤';
                }
                if (this.name) {
                    return this.name+' '+suffix;
                }
                const result = this._('clock-timer.label.clock-timer');
                if (this.topic && (this.topic.length + result.length <= 32)) {
                    return this.topic + ':' + result+' '+suffix;
                }
                return result+' '+suffix;
            },
            labelStyle() {
                return this.name ? 'node_label_italic' : '';
            },
            paletteLabel() { return this._('clock-timer.label.clock-timer-palette'); },
            oneditprepare() {
                setTimeout(() => {
                    $('.is-to-show-initially').show();
                    $('.is-to-hide-initially').hide();
                }, 300);
                $('.rdg-ui-btn').button();

                this.outputs = this.outputs || 1;
                const $nodeConfig = $('#node-input-positionConfig');
                const node = this;
                const setup = function(node) {
                    /* global getTypes getSelectFields setupTInput appendOptions getBackendData bdDateToTime initCombobox initCheckboxesBlock autocomplete getCheckboxesStr setTInputValue */
                    // #region initialize
                    const types = getTypes(node);
                    const selFields = getSelectFields();
                    /**
                    * update multiplier settings from a previous version
                    * @param {number} mp - the multiplier value
                    * @param {string} name - the name of the element
                    * @param {function} onchange - the function to be called on field change
                    * @returns {number} the updated multiplier value
                    */
                    function multiplierUpdate(mp, name, onchange) {
                        const $field = $('#node-input-' + name);
                        appendOptions(node, $field, 'multiplier', data => (data.id > 0));
                        if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                            mp = 60000;
                        } else {
                            mp = parseFloat(mp);
                            if (mp === 1) {
                                mp = 1000;
                            } else if (mp === 60) {
                                mp = 60000;
                            } else if (mp === 3600) {
                                mp = 3600000;
                            }
                        }
                        $field.val(mp);
                        $field.on('change', onchange);
                        return mp;
                    }
                    /**
                     * save rules
                     * @param {*} node - the node representation
                     * @param {string} name - the node representation
                     * @param {*} element - the node representation
                     * @param {function} validate - ovalidation function of the input
                     * @param {number} defMultiplier - default multiplier (in ms)
                     * @param {number} minMultiplier - minimum multiplier (in ms)
                    */
                    function setMultiplier(node, name, element, validate, defMultiplier, minMultiplier) {
                        const c = Number(node[name]);
                        if (node[name] !== '' && !isNaN(c)) {
                            let r = minMultiplier || 1000;
                            if (c % 86400000 === 0) {
                                r = 86400000; // Days
                            } else if (c % 3600000 === 0) {
                                r = 3600000; // Hours
                            } else if (c % 60000 === 0) {
                                r = 60000; // Minutes
                            }
                            $('#time-control-' + name).val(c/r);
                            $('#time-control-' + name + '-multiplier').val(r);
                        } else {
                            $('#time-control-' + name).val('');
                            $('#time-control-' + name + '-multiplier').val(defMultiplier || 1000);
                        }
                        $('#time-control-' + name).on('change focus focusout', () => {
                            const el = $('#time-control-' + name);
                            let val = el.val();
                            const mp = $('#time-control-' + name + '-multiplier').val();
                            if (isNaN(val) || val === '' || val === 0) {
                                val = '';
                                $('node-input-' + name).val('');
                            } else {
                                val = val * mp;
                                $('#node-input-' + name).val(val);
                            }

                            if (typeof validate === 'function') {
                                if (validate(val)) {
                                    el.removeClass( 'input-error' );
                                } else {
                                    el.addClass( 'input-error' );
                                }
                            }
                        });

                        $('#time-control-' + name + '-multiplier').change( () => {
                            $('#time-control-' + name).change();
                        });
                        $('#time-control-' + name).change();
                    }
                    // #endregion initialize
                    // #region payloadDefault
                    // console.log('clock-timer payloadDefault');
                    if (node.payloadDefaultType === null) {
                        node.payloadDefaultType = types.Undefined.value;
                    } else if (node.payloadDefaultType === 'string') {
                        node.payloadDefaultType = 'str';
                    }
                    setupTInput(node, {
                        typeProp: 'payloadDefaultType',
                        valueProp: 'payloadDefault',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.MsgPayload,
                            types.MsgValue,
                            'str',
                            'num',
                            'bool',
                            'date',
                            types.DateSpecific,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata',
                            types.TimeEntered,
                            types.DateEntered,
                            types.TimeSun,
                            types.TimeSunNow,
                            types.TimeMoon,
                            types.DayOfMonth,
                            types.SunCalc,
                            types.SunInSky,
                            types.MoonCalc,
                            types.MoonPhase,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunAzimuthRad,
                            types.SunElevationRad,
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevation,
                            types.SunTimeByAzimuthRad,
                            types.SunTimeByElevationRad,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ],
                        onChange(_type, _value) {
                            const plVType = $('#node-input-payloadDefault').typedInput('type');
                            if (plVType ===  types.TimeEntered.value ||
                                plVType === types.TimeSun.value ||
                                plVType === types.TimeMoon.value ||
                                plVType === types.DateSpecific.value) {
                                $('.clock-timer-row-payloadDefaultTimeFormat').show();
                                $('.clock-timer-row-payloadDefaultOffset').show();
                            } else if (plVType ===  types.TimeSunNow.value) {
                                $('.clock-timer-row-payloadDefaultTimeFormat').hide();
                                $('.clock-timer-row-payloadDefaultOffset').show();
                            } else {
                                $('.clock-timer-row-payloadDefaultTimeFormat').hide();
                                $('.clock-timer-row-payloadDefaultOffset').hide();
                            }
                            getBackendData(d => {
                                const $div = $('#node-input-payloadDefault-div');
                                const titleOrg = $div.attr('titleOrg');
                                // $div.attr('title', ((d) ? (String(d) + ' - ') : '') + titleOrg);
                                $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                            }, {
                                nodeId:     node.id,
                                kind:       'getOutDataData',
                                config:     $nodeConfig.val(),
                                type:       plVType,
                                value:      $('#node-input-payloadDefault').typedInput('value'),
                                format:     $('#node-input-payloadDefaultTimeFormat').val(),
                                offsetType: $('#node-input-payloadDefaultOffset').typedInput('type'),
                                offset:     $('#node-input-payloadDefaultOffset').typedInput('value'),
                                multiplier: $('#node-input-payloadDefaultOffsetMultiplier').val(),
                                noOffsetError: true
                            });
                        }
                    });
                    initCombobox(node, $('#node-input-payloadDefaultTimeFormatsel'), $('#node-input-payloadDefaultTimeFormat'), 'dateOutFormat', 'outputFormats', node.payloadDefaultTimeFormat || 0, 30);

                    node.payloadDefaultOffsetMultiplier = multiplierUpdate(node.payloadDefaultOffsetMultiplier, 'payloadDefaultOffsetMultiplier', () => $('#node-input-payloadDefault').change());
                    setupTInput(node, {
                        typeProp: 'payloadDefaultOffsetType',
                        valueProp: 'payloadDefaultOffset',
                        width: 'calc(100% - 255px)',
                        defaultType: (node.payloadDefaultOffset === 0 || node.payloadDefaultOffset === '') ? types.Undefined.value : 'num',
                        defaultValue: 0,
                        types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                        onChange(_type, _value) {
                            const type = $('#node-input-payloadDefaultOffset').typedInput('type');
                            if (type === types.Undefined.value) {
                                $('#node-input-payloadDefaultOffsetMultiplier').prop('disabled', true);
                            } else {
                                $('#node-input-payloadDefaultOffsetMultiplier').prop('disabled', false);
                            }
                            $('#node-input-payloadDefault').change();
                        }
                    });
                    // #endregion payloadDefault
                    // #region rules
                    // console.log('clock-timer rules');
                    /**
                     * get a time in millisecond as string of the format hh:mm, hh:mm:ss or hh:mm:ss.mss
                     * @param {number} s - milisecond
                     * @returns {string} time as string
                     */
                    function msToTime(s) {
                        // Pad to 2 or 3 digits, default is 2
                        const pad = (n, z = 2) => ('00' + n).slice(-z);
                        const sec = (s%6e4)/1000|0;
                        const msec = s%1000;
                        return pad(s/3.6e6|0) + ':' + pad((s%3.6e6)/6e4 | 0) + ((msec >0) ? (':' + pad(sec) +'.' + pad(msec, 3) ) : ((sec>0) ? ':' + pad(sec) : ''));
                    }

                    /**
                     * get the time offset text
                     */
                    function _getOffsetText(node, t,v,m) {
                        let result = '';
                        if (t && t !== 'none') {
                            if (t === 'num') {
                                const osmillis = v * m;
                                if (osmillis>0) {
                                    result += ' + ' + msToTime(osmillis);
                                } else {
                                    result += ' - ' +msToTime(osmillis * -1);
                                }
                            } else {
                                result += ' offset <var>' + RED.nodes.getType('position-config').getValueLabel(node, t, v) + '</var>';
                                // result += ' * ' + data.multiplier/1000 + 's';
                            }
                        }
                        return result;
                    }
                    /**
                     * get a formated date limit
                    */
                    function getDateShort(value) {
                        if (value) {
                            const val = value.split('-');
                            if (val.length > 2) {
                                return val[1] + '-' + val[2];
                            } else if (val.length === 2) {
                                return val[0] + '-' + val[1];
                            }
                        }
                        return '';
                    }
                    /**
                     * get a description of the rule rules
                     * @param {object} data - a rule description
                     * @returns {string} description of the rule
                     */
                    function getRuleDescription(node, selFields, data, enh) {
                        let result = '';
                        try {
                            if (typeof data.valid === 'undefined') {
                                result += '<div>The rule is out of date, but should work normally regardless. If possible, please open the rule, save and re-deploy the node. This updates the data structures.</div>';
                            } else if (!data.valid || !data.isValid) {
                                result += '<div>Rule is invalid and needs to be changed!!</div>';
                            }
                            if (data.validOperandAType && data.validOperandAType !== 'none') {
                                result += '<div>';
                                result += '<i class="fa fa-code-fork" aria-hidden="true"></i> ';

                                result += '<var>' + RED.nodes.getType('position-config').getValueLabel(node, data.validOperandAType,data.validOperandAValue) + '</var>';
                                // result += node._('node-red-contrib-sun-position/position-config:common.comparatorDescription.' + data.validOperator);
                                result += ' ' + data.validOperatorText;
                                let operatorCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === data.validOperator) {
                                        operatorCount = el.operatorCount;
                                        break;
                                    }
                                }

                                if (operatorCount > 1) {
                                    result += ' ' + RED.nodes.getType('position-config').getValueLabel(node, data.validOperandBType, data.validOperandBValue);
                                }
                                if (data.valid2LogOperator > 0 && data.valid2OperandAType !== 'none') {
                                    result += '<br/><strong>' + data.valid2LogOperatorText + '</strong> ';

                                    result += '<var>' + RED.nodes.getType('position-config').getValueLabel(node, data.valid2OperandAType,data.valid2OperandAValue) + '</var>';
                                    result += ' ' + data.valid2OperatorText;
                                    let operatorCount = 1;
                                    const fields = selFields.comparator;
                                    const fieldsLength = fields.length;
                                    for (let index = 0; index < fieldsLength; index++) {
                                        const el = fields[index];
                                        if (el.id === data.valid2Operator) {
                                            operatorCount = el.operatorCount;
                                            break;
                                        }
                                    }

                                    if (operatorCount > 1) {
                                        result += ' ' + RED.nodes.getType('position-config').getValueLabel(node, data.valid2OperandBType, data.valid2OperandBValue);
                                    }
                                }
                                result += '</div>';
                            }
                            if (data.timeType && data.timeType !== 'none') {
                                result += '<div>';
                                result += '<i class="fa fa-clock-o" aria-hidden="true"></i> ';
                                result += data.timeOpText;
                                result += ' <var>' + RED.nodes.getType('position-config').getValueLabel(node, data.timeType, data.timeValue) + '</var>';
                                result += _getOffsetText(node, data.offsetType, data.offsetValue, data.multiplier);
                                if (enh && enh.timeReg && enh.timeReg.text) {
                                    result += ' <i class="fa fa-hand-o-right indent-enh-text" aria-hidden="true"></i>&nbsp;<kbd>' + enh.timeReg.text + '</kbd>';
                                }

                                if (data.timeMinType && data.timeMinType !== 'none') {
                                    result += '<div class="indent-time-text"><i class="fa fa-step-backward" aria-hidden="true"></i> <span>';
                                    result += node._('clock-timer.label.ruleTimeMin');
                                    result += '</span> <var>';
                                    result += RED.nodes.getType('position-config').getValueLabel(node, data.timeMinType, data.timeMinValue);
                                    result += '</var>';
                                    result += _getOffsetText(node, data.offsetMinType, data.offsetMinValue, data.multiplierMin);
                                    if (enh && enh.timeMin && enh.timeMin.text) {
                                        result += ' <i class="fa fa-hand-o-right indent-enh-text" aria-hidden="true"></i>&nbsp;<kbd>' + enh.timeMin.text + '</kbd>';
                                    }
                                    result += '</div>';
                                }
                                if (data.timeMaxType && data.timeMaxType !== 'none') {
                                    result += '<div class="indent-time-text"><i class="fa fa-step-forward" aria-hidden="true"></i> <span>';
                                    result += node._('clock-timer.label.ruleTimeMax');
                                    result += '</span> <var>';
                                    result += RED.nodes.getType('position-config').getValueLabel(node, data.timeMaxType, data.timeMaxValue);
                                    result += '</var>';
                                    result += _getOffsetText(node, data.offsetMaxType, data.offsetMaxValue, data.multiplierMax);
                                    if (enh && enh.timeMax && enh.timeMax.text) {
                                        result += ' <i class="fa fa-hand-o-right indent-enh-text" aria-hidden="true"></i>&nbsp;<kbd>' + enh.timeMax.text + '</kbd>';
                                    }
                                    result += '</div>';
                                }
                                if ((data.timeDays && data.timeDays !== '*') || data.timeOnlyEvenDays || data.timeOnlyOddDays) {
                                    result += '<div class="indent-time-days"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('clock-timer.label.ruleTimeDays');
                                    result += '</span> <var>';
                                    const resultArr = [];
                                    if (data.timeDays && data.timeDays !== '*') {
                                        const daysarr = data.timeDays.split(',');
                                        if (daysarr.length === 1) {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7)));
                                        } else if (data.timeDays === '5,6,0') {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.days.12') + '-' +
                                                node._('node-red-contrib-sun-position/position-config:common.days.7'));
                                        } else if (daysarr.length === 2) {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7)) + ',' +
                                                node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[1]) + 7)));
                                        } else {
                                            daysarr.sort((a, b) => parseInt(a) - parseInt(b));
                                            let isok = true;
                                            let elF = parseInt(daysarr[0]);
                                            daysarr[0] = node._('node-red-contrib-sun-position/position-config:common.days.'+(elF + 7));
                                            for (let index = 1; index < daysarr.length; index++) {
                                                const element = parseInt(daysarr[index]);
                                                isok = isok && (element === elF+1);
                                                elF = element;
                                                daysarr[index] = node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(element) + 7));
                                            }
                                            if (isok) {
                                                resultArr.push(daysarr[0] + '-' + daysarr[daysarr.length-1]);
                                            } else {
                                                resultArr.push(daysarr.join(','));
                                            }
                                        }
                                    }
                                    if (data.timeOnlyEvenDays) {
                                        resultArr.push(node._('clock-timer.label.onlyOddDays'));
                                    }
                                    if (data.timeOnlyOddDays) {
                                        resultArr.push(node._('clock-timer.label.onlyEvenDays'));
                                    }
                                    result += resultArr.join(' <b>and</b> ');
                                    result += '</var></div>';
                                }

                                if (data.timeMonths && data.timeMonths !== '*') {
                                    result += '<div class="indent-time-months"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('clock-timer.label.ruleTimeMonths');
                                    result += '</span> <var>';
                                    const montharr = data.timeMonths.split(',');
                                    if (montharr.length === 2) {
                                        result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                                        result += ',';
                                        result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[1]) + 12));
                                    } else if (montharr.length === 1) {
                                        result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                                    } else {
                                        montharr.sort((a, b) => parseInt(a) - parseInt(b));
                                        let isok = true;
                                        let elF = parseInt(montharr[0]);
                                        montharr[0] = node._('node-red-contrib-sun-position/position-config:common.months.'+(elF + 12));
                                        for (let index = 1; index < montharr.length; index++) {
                                            const element = parseInt(montharr[index]);
                                            isok = isok && (element === elF+1);
                                            elF = element;
                                            montharr[index] = node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(element) + 12));
                                        }
                                        if (isok) {
                                            result += montharr[0];
                                            result += '-';
                                            result += montharr[montharr.length-1];
                                        } else {
                                            result += montharr.join(',');
                                        }
                                    }
                                    result += '</var></div>';
                                }

                                if (data.timeDateStart || data.timeDateEnd) {
                                    result += '<div class="indent-time-datelimit"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                    result += node._('clock-timer.label.ruleTimeLimitStart');
                                    result += '</span> <var>';
                                    if (enh) {
                                        const year = (new Date()).getFullYear();
                                        result += data.timeDateStart || year + '-01-01';
                                    } else {
                                        result += (getDateShort(data.timeDateStart) || '01-01');
                                    }
                                    result += '</var> <span> ';
                                    result += node._('clock-timer.label.ruleTimeLimitEnd');
                                    result += '</span> <var>';
                                    if (enh) {
                                        const year = (new Date()).getFullYear();
                                        result += data.timeDateEnd || year + '-12-31';
                                    } else {
                                        result += (getDateShort(data.timeDateEnd) || '12-31');
                                    }
                                    result += '</var></div>';
                                }
                                result += '</div>';
                            }
                            result += '<div>';
                            if (data.payloadType && data.payloadType !== 'none') {
                                result += '<div class="indent-payload-text"><i class="fa fa-step-backward" aria-hidden="true"></i> <span>';
                                result += node._('clock-timer.label.rulePayload');
                                result += '</span> <var>';
                                result += RED.nodes.getType('position-config').getValueLabel(node, data.payloadType, data.payloadValue);
                                result += '</var>';
                                result += _getOffsetText(node, data.payloadOffsetType, data.payloadOffsetValue, data.payloadOffsetMultiplier);
                                result += '</div>';
                                if (data.topic) {
                                    result += '<div class="indent-topic-text"> <span>';
                                    result += node._('clock-timer.label.ruleTopic');
                                    result += '</span> <var>';
                                    result += data.topic;
                                    result += '</var>';
                                    result += '</div>';
                                }
                                if (data.resetOverwrite) {
                                    result += '<div class="indent-resetOverwrite-text"> <span>';
                                    result += node._('clock-timer.label.ruleResetOverwrite');
                                    result += '</span> </div>';
                                }
                            } else {
                                result += node._('clock-timer.label.rulePayloadND');
                            }
                            result += '</div>';
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            result = 'Error: "' + err.message + '"';
                        }
                        return result;
                    }
                    /**
                     * resizes a rule container
                     */
                    function resizeContainer() {
                        try {
                            const editorRow = $('.node-input-rule-container-row ol');
                            const height = editorRow.outerHeight(true);
                            const rows = $('#node-input-rule-container').editableList('items');
                            if (rows.size() > 0) {
                                $('#node-input-rule-container').editableList('height', height + 40);
                            } else {
                                $('#node-input-rule-container').editableList('height', 20);
                            }
                        } catch (ex) {
                            console.log(ex); // eslint-disable-line
                        }
                    }

                    let resizeContainerTO = null;
                    $('#node-input-rule-container').css('min-height', '80px').css('min-width', '300px').editableList({
                        addItem($containerRow, containerIndex, data) {
                            if (data === {}) {
                                data.description = 'please edit rule';
                                data.name = 'empty';
                            }
                            data.valid = {};
                            data.isValid = false;
                            data.index = containerIndex;
                            data.importance = 0;
                            data.validOperandAType = (data.validOperandAType || types.Unlimited.value);
                            data.validOperandBType = (data.validOperandBType || 'num');
                            data.valid2LogOperator = (parseInt(data.valid2LogOperator) || 0);
                            data.valid2OperandAType = (data.valid2OperandAType || 'msg');
                            data.valid2OperandBType = (data.valid2OperandBType || 'num');
                            data.timeDays = (data.timeDays || '*');
                            data.timeMonths = (data.timeMonths || '*');
                            data.timeOnlyOddDays = (data.timeOnlyOddDays || false);
                            data.timeOnlyEvenDays = (data.timeOnlyEvenDays || false);
                            data.timeDateStart = (data.timeDateStart || '');
                            data.timeDateEnd = (data.timeDateEnd || '');
                            data.timeOp = (parseInt(data.timeOp) || 0);
                            data.timeType = (data.timeType || types.Undefined.value); // TimeEntered
                            data.timeValue = (data.timeValue || '');
                            data.offsetType = (data.offsetType || types.Undefined.value);
                            data.multiplier = (parseInt(data.multiplier) || 60000);

                            data.timeMinType = (data.timeMinType || types.Undefined.value);
                            data.timeMinValue = (data.timeMinValue || '');
                            data.offsetMinType = (data.offsetMinType || types.Undefined.value);
                            data.multiplierMin = (parseInt(data.multiplierMin) || 60000);

                            data.timeMaxType = (data.timeMaxType || types.Undefined.value);
                            data.timeMaxValue = (data.timeMaxValue || '');
                            data.offsetMaxType = (data.offsetMaxType || types.Undefined.value);
                            data.multiplierMax = (parseInt(data.multiplierMax) || 60000);

                            data.payloadType = (data.payloadType || 'none');
                            data.payloadValue = (data.payloadValue || '');
                            data.payloadOffsetType = (data.payloadOffsetType || types.Undefined.value);
                            data.payloadOffsetMultiplier = (parseInt(data.multiplier) || 60000);
                            data.payloadFormat = (parseInt(data.payloadFormat) || 99);

                            $containerRow.data('ruleData', JSON.stringify(data));
                            $containerRow.css({ overflow: 'hidden'}); // , whiteSpace: 'nowrap'
                            const $row0 = $('<div/>').appendTo($containerRow);
                            const $div = $('<div/>', {
                                class: 'clock-timer-rule-mainblock'
                            }).appendTo($row0);
                            $('<span />', {
                                id: 'rule-name-'+containerIndex,
                                class: 'clock-timer-rule-name-span'
                            }).append(data.name || 'rule ' + (containerIndex + 1)).appendTo( $div );
                            if (!data.description) {
                                data.description = getRuleDescription(node, selFields, data);
                            }
                            $('<div />', {
                                id: 'rule-description-'+containerIndex,
                                class: 'clock-timer-rule-description-span'
                            }).append(data.description).appendTo( $div );
                            const finalspan1 = $('<span/>',{
                                class:'clock-timer-rule-finalspan'
                            }).appendTo($row0);
                            finalspan1.append('<span class="node-input-rule-index">'+(containerIndex+1)+'</span> ');
                            const $btnEdit = $('<a />', {
                                class: 'red-ui-button red-ui-button-small clock-timer-rule-editBtn',
                                title: node._('clock-timer.label.editRule')
                            }).append('<i class= "fa fa-pencil-square-o" ></i>').appendTo($row0);
                            const $btnCpy = $('<a />', {
                                class: 'red-ui-button red-ui-button-small clock-timer-rule-duplicateBtn',
                                title: node._('clock-timer.label.duplicateRule')
                            }).append('<i class= "fa fa-clone" ></i>').appendTo($row0);
                            $btnEdit.click(() => {
                                _dialogLoadData(containerIndex, $containerRow);
                            });
                            $btnCpy.click(() => {
                                _dialogDuplicateRule(containerIndex, $containerRow);
                            });

                            if (resizeContainerTO) { clearTimeout(resizeContainerTO); }
                            resizeContainerTO = setTimeout(() => {
                                resizeContainerTO = null;
                                $('#node-input-payloadDefaultOffset').change();
                                resizeContainer();
                            }, 1000);
                        },
                        addButton: false,
                        sortable: true,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem(_opt) {
                            const rules = $('#node-input-rule-container').editableList('items');
                            rules.each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                            resizeContainer();
                        },
                        sortItems(_rules) {
                            const rules = $('#node-input-rule-container').editableList('items');
                            rules.each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                        }
                    });

                    // #region Button
                    const $btnAdd = $('#node-button-add');
                    $btnAdd.click(() => {
                        $('#node-input-rule-container').editableList('addItem', {});
                    });

                    const $btnClear = $('#node-button-clear');
                    $btnClear.click(() => {
                        $('#node-input-rule-container').editableList('empty');
                        resizeContainer();
                    });

                    const $btnSort = $('#node-button-sort');
                    $btnSort.click(() => {
                        const prerules = $('#node-input-rule-container').editableList('items');
                        prerules.each(function(i) {
                            const data = $(this).data('data');
                            data.index = i;
                            data.conditional = ((data.validOperandAType !== 'none') ? 1 : 0);
                            data.timeLimited = ((data.timeType !== 'none') ? 1 : 0);
                            data.timeData = (parseFloat($(this).find('.node-input-rule-timeReg').attr('timedata')) || 0);
                            data.timeOp = (data.timeLimited) ? (Number(data.timeOp) || 0) : -1;
                        });
                        /**
                         * 1 no time
                         * 2 time    - until
                         * 3 time    - from
                         */
                        $('#node-input-rule-container').editableList('sort', (a, b) => {
                            const pos = (a.index - b.index);
                            if (!a.timeLimited && !b.timeLimited) { // both not time limited
                                return pos;
                            }
                            // both are time limited
                            const top = (a.timeOp - b.timeOp);
                            if (top !== 0) {
                                return top; // from before until; not timeLimited before timeLimited (1-3)
                            }

                            const time = a.timeData - b.timeData;
                            if ((a.timeData !== 0) && (b.timeData !== 0) && (time !== 0)) { // time is different
                                return time;
                            }
                            return pos;
                        });
                        const postrules = $('#node-input-rule-container').editableList('items');
                        postrules.each(function(i) {
                            $(this).find('.node-input-rule-index').html(i+1);
                            const data = $(this).data('data');
                            data.index = i;
                        });
                    });
                    // #endregion Button
                    // fill rules
                    if (node.rules) {
                        for (let i = 0; i < node.rules.length; i++) {
                            const rule = node.rules[i];
                            // rule.index = i;
                            $('#node-input-rule-container').editableList('addItem', rule);
                        }
                    }
                    // #endregion rules
                    // #region Enhanced settings
                    setMultiplier(node,'overwriteExpire', v => {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number()(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }, 3600000, 1000);
                    setMultiplier(node,'autoTriggerTime', v => {
                        const n = parseFloat(v);
                        return (RED.validators.number()(v) && (n >= 60000) && (n < 0x7FFFFFFF));
                    }, 3600000, 60000);
                    setMultiplier(node,'startDelayTime', v => {
                        const n = parseFloat(v);
                        return (RED.validators.number()(v) && (n >= 0) && (n < 0x7FFFFFFF));
                    }, 600000, 0);

                    $('.spinner-time').spinner({
                        max: 1439,
                        min: 0,
                        step: 1
                    });
                    $('#node-input-autoTrigger').change( () => {
                        if ($('#node-input-autoTrigger').is(':checked')) {
                            $('#time-control-autoTriggerTime-edit').show();
                        } else {
                            $('#time-control-autoTriggerTime-edit').hide();
                        }
                    });
                    $('#node-input-autoTrigger').change();
                    // #endregion Enhanced settings
                    // #region dialog
                    const $dialog = $('#dialog-edit-rule').dialog({
                        title: node._('clock-timer.label.dialogtitle'),
                        autoOpen: false,
                        resizable: true,
                        height: Math.min(750, $(window).height() * 0.9), // 1024
                        width: Math.min(850, $(window).width() * 0.9),
                        modal: true,
                        closeOnEscape: true,
                        classes : {
                            'ui-dialog': 'ui-dialog-rdg ',
                            'ui-dialog-content': 'ui-dialog-content-rdg ',
                            'ui-dialog-titlebar': 'ui-dialog-titlebar-rdg'
                        },
                        buttons: {
                            Ok() {
                                _dialogSaveData();
                                $dialog.dialog( 'close' );
                                $dialogDataRow = null;
                                dialogDataIndex = -1;
                            },
                            Cancel() {
                                $dialog.dialog( 'close' );
                                $dialogDataRow = null;
                                dialogDataIndex = -1;
                            }
                        }
                    });

                    const $dialogName = $dialog.find('#dlg-ip-clktime-rule-name');
                    let $dialogDataRow = null;
                    let dialogDataOnLoading = false;
                    let dialogDataIndex = -1;
                    const dialogAddData = {};
                    /**
                     * Build the dialog
                     */
                    // #region dialogCond1
                    const $dialogCondAOperand = $dialog.find('#dlg-ip-clktime-rule-condAOperand');
                    $dialogCondAOperand.typedInput({
                        default: types.Unlimited.value,
                        types: [
                            types.Unlimited,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.PhaseMoon,
                            types.MsgPayload,
                            types.MsgValue,
                            types.MsgPayloadByTopic,
                            types.SunInSky,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunAzimuthRad,
                            types.SunElevationRad,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ]
                    });
                    $dialogCondAOperand.typedInput('width', '40%'); // calc(100% - 220px)

                    const $dialogCondAOperator = $dialog.find('#dlg-ip-clktime-rule-condAOperator');
                    appendOptions(node, $dialogCondAOperator, 'comparator');
                    const $dialogCondBOperand = $dialog.find('#dlg-ip-clktime-rule-condBOperand');
                    $dialogCondBOperand.typedInput({
                        default: 'num',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    $dialogCondBOperand.typedInput('width', '70%');
                    // #endregion dialogCond1
                    // #region dialogCond2
                    const $dialogCond2LogOperator = $dialog.find('#dlg-ip-clktime-rule-cond2LogOperator');
                    $dialogCond2LogOperator.append($('<option></option>').val(0).text(node._('clock-timer.label.ruleCondNone')));
                    $dialogCond2LogOperator.append($('<option></option>').val(1).text(node._('clock-timer.label.ruleCondOr')));
                    $dialogCond2LogOperator.append($('<option></option>').val(2).text(node._('clock-timer.label.ruleCondAnd')));

                    const $dialogCond2AOperand = $dialog.find('#dlg-ip-clktime-rule-cond2AOperand');
                    $dialogCond2AOperand.typedInput({
                        default: 'msg',
                        types: [
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.PhaseMoon,
                            types.MsgPayload,
                            types.MsgValue,
                            types.MsgPayloadByTopic,
                            types.SunInSky,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunAzimuthRad,
                            types.SunElevationRad,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ]
                    });
                    $dialogCond2AOperand.typedInput('width', '40%'); // calc(100% - 220px)

                    const $dialogCond2AOperator = $dialog.find('#dlg-ip-clktime-rule-cond2AOperator');
                    appendOptions(node, $dialogCond2AOperator, 'comparator');
                    const $dialogCond2BOperand = $dialog.find('#dlg-ip-clktime-rule-cond2BOperand');
                    $dialogCond2BOperand.typedInput({
                        default: 'num',
                        types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                    });
                    $dialogCond2BOperand.typedInput('width', '70%');
                    // #endregion dialogCond2
                    // #region dialogTimeReg
                    const $dialogTimeRegOperator = $dialog.find('#dlg-ip-clktime-rule-timeReg-operator');
                    $dialogTimeRegOperator.append($('<option></option>').val(0).text(node._('clock-timer.label.ruleTimeUntil')));
                    $dialogTimeRegOperator.append($('<option></option>').val(1).text(node._('clock-timer.label.ruleTimeFrom')));

                    const $dialogTimeRegInput = $dialog.find('#dlg-ip-clktime-rule-timeReg');
                    $dialogTimeRegInput.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata', types.SunTimeByAzimuth, types.SunTimeByAzimuthRad]
                    });
                    $dialogTimeRegInput.typedInput('width', '40%');

                    const $dialogTimeRegMultiplier = $dialog.find('#dlg-ip-clktime-rule-multiplier-timeReg');
                    appendOptions(node, $dialogTimeRegMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeRegOffset = $dialog.find('#dlg-ip-clktime-rule-offset-timeReg');
                    $dialogTimeRegOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata', types.randomNumber]
                    }).change(() => {
                        const type = $dialogTimeRegOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeRegMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeRegMultiplier.prop('disabled', false);
                        }
                        $dialogTimeRegInput.change();
                    });
                    $dialogTimeRegOffset.typedInput('width', '40%');
                    // #endregion dialogTimeReg
                    // #region dialogTimeMin
                    const $dialogTimeMinInput = $dialog.find('#dlg-ip-clktime-rule-timeMin');
                    $dialogTimeMinInput.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata', types.SunTimeByAzimuth, types.SunTimeByAzimuthRad]
                    });
                    $dialogTimeMinInput.typedInput('width', '40%');

                    const $dialogTimeMinMultiplier = $dialog.find('#dlg-ip-clktime-rule-multiplier-timeMin');
                    appendOptions(node, $dialogTimeMinMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeMinOffset = $dialog.find('#dlg-ip-clktime-rule-offset-timeMin');
                    $dialogTimeMinOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata', types.randomNumber]
                    }).change(() => {
                        const type = $dialogTimeMinOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeMinMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeMinMultiplier.prop('disabled', false);
                        }
                        $dialogTimeMinInput.change();
                    });
                    $dialogTimeMinOffset.typedInput('width', '40%');
                    // #endregion dialogTimeMin
                    // #region dialogTimeMax
                    const $dialogTimeMaxInput = $dialog.find('#dlg-ip-clktime-rule-timeMax');
                    $dialogTimeMaxInput.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata', types.SunTimeByAzimuth, types.SunTimeByAzimuthRad]
                    });
                    $dialogTimeMaxInput.typedInput('width', '40%');

                    const $dialogTimeMaxMultiplier = $dialog.find('#dlg-ip-clktime-rule-multiplier-timeMax');
                    appendOptions(node, $dialogTimeMaxMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeMaxOffset = $dialog.find('#dlg-ip-clktime-rule-offset-timeMax');
                    $dialogTimeMaxOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata', types.randomNumber]
                    }).change(() => {
                        const type = $dialogTimeMaxOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeMaxMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeMaxMultiplier.prop('disabled', false);
                        }
                        $dialogTimeMaxInput.change();
                    });
                    $dialogTimeMaxOffset.typedInput('width', '40%');
                    // #endregion dialogTimeMax
                    // #region dialogTimeLimit
                    $dialog.find('#dialog-row-timeConstraints-show').click(() => {
                        $dialog.find('#dialog-row-timeConstraintsPlaceholder').hide();
                        $dialog.find('#dialog-row-timeConstraints').fadeIn('slow');
                    });

                    $dialog.find('#dialog-row-timeConstraints-hide').click(() => {
                        $dialog.find('#dialog-row-timeConstraintsPlaceholder').fadeIn('slow');
                        $dialog.find('#dialog-row-timeConstraints').hide();
                    });
                    const $dialogTimeLimitOnlyEvenDays = $dialog.find('#dlg-ip-clktime-rule-timeOnlyEvenDays');
                    const $dialogTimeLimitOnlyOddDays = $dialog.find('#dlg-ip-clktime-rule-timeOnlyOddDays');
                    const $dialogTimeLimitDateStart = $dialog.find('#dlg-ip-clktime-rule-timedatelimit-start');
                    const $dialogTimeLimitDateEnd = $dialog.find('#dlg-ip-clktime-rule-timedatelimit-end');
                    $dialogTimeLimitDateStart.change(() => {
                        const year = (new Date()).getFullYear();
                        $dialogTimeLimitDateEnd.attr('min', year + '-' + (getDateShort($dialogTimeLimitDateStart.val()) || '01-01'));
                        $dialogTimeLimitDateEnd.attr('max', (year + 1) + '-' + (getDateShort($dialogTimeLimitDateStart.val()) || '12-31'));
                    });
                    $dialogTimeLimitDateEnd.change(() => {
                        const year = (new Date()).getFullYear();
                        $dialogTimeLimitDateStart.attr('min', year + '-01-01');
                        $dialogTimeLimitDateStart.attr('max', $dialogTimeLimitDateEnd.val() || (year + '-12-31'));
                    });
                    // #endregion dialogTimeLimit
                    // #region dialogPayload
                    const $dialogPayload = $dialog.find('#dlg-ip-clktime-rule-payload');
                    $dialogPayload.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.MsgPayload,
                            types.MsgValue,
                            'str',
                            'num',
                            'bool',
                            'date',
                            types.DateSpecific,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata',
                            types.TimeEntered,
                            types.DateEntered,
                            types.TimeSun,
                            types.TimeSunNow,
                            types.TimeMoon,
                            types.DayOfMonth,
                            types.SunCalc,
                            types.SunInSky,
                            types.MoonCalc,
                            types.MoonPhase,
                            types.SunAzimuth,
                            types.SunElevation,
                            types.SunAzimuthRad,
                            types.SunElevationRad,
                            types.SunTimeByAzimuth,
                            types.SunTimeByElevation,
                            types.SunTimeByAzimuthRad,
                            types.SunTimeByElevationRad,
                            types.isDST,
                            types.WeekOfYear,
                            types.WeekOfYearEven,
                            types.DayOfYear,
                            types.DayOfYearEven
                        ]
                    });
                    $dialogPayload.typedInput('width', '40%');

                    const $dialogPayloadOffset = $dialog.find('#dlg-ip-clktime-rule-payloadOffset');
                    $dialogPayloadOffset.typedInput({
                        default: types.Undefined.value,
                        types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata', types.randomNumber]
                    }).change(() => { $dialogPayload.change(); });
                    $dialogPayloadOffset.typedInput('width', '40%');

                    const $dialogPayloadMultiplier = $dialog.find('#dlg-ip-clktime-rule-payloadOffsetMultiplier');
                    appendOptions(node, $dialogPayloadMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogPayloadTimeFormat = $dialog.find('#dlg-ip-clktime-rule-payloadTimeFormat');
                    const $dialogPayloadTimeFormatsel = $dialog.find('#dlg-ip-clktime-rule-payloadTimeFormatsel');

                    appendOptions(node, $dialogPayloadTimeFormatsel, 'outputFormats');
                    autocomplete($dialogPayloadTimeFormat, 'dateOutFormat');
                    // #endregion dialogPayload
                    // #region default topic + importance
                    const $dialogResetOverwrite = $dialog.find('#dlg-ip-clktime-rule-resetOverwrite');
                    $dialogResetOverwrite.change(() => { _dialogGenHelpText(); });
                    const $dialogImportance = $dialog.find('#dlg-ip-clktime-rule-importance');
                    $dialogImportance.spinner({
                        max: 1000,
                        min: 0,
                        step: 1,
                        stop:(_e, _ui) => { _dialogGenHelpText(); }
                    });
                    $dialogImportance.change(() => { _dialogGenHelpText(); });
                    const $dialogTopic = $dialog.find('#dlg-ip-clktime-rule-topic');
                    $dialogTopic.change(() => { _dialogGenHelpText(); });
                    // #endregion default topic + importance
                    // #region dialogChange
                    $dialogTimeRegInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opType = $dialogTimeRegInput.typedInput('type');
                        if (opType === types.Undefined.value) {
                            dialogAddData.timeReg = {
                                ts : 0,
                                data : null,
                                text : 'N/A'
                            };
                            $('#dialog-row-timeReg').attr('title', dialogAddData.timeReg.text);
                            $dialogTimeRegInput.attr('timedata', dialogAddData.timeReg.ts);
                            $dialogTimeRegOperator.hide();
                            $('#dialog-row-offset-timeReg').hide();
                            $('#dialog-row-timeReg').attr('title', opType);

                            $('#dialog-row-timeMin').hide();
                            $('#dialog-row-timeMax').hide();
                            $('#dialog-row-offset-timeMin').hide();
                            $('#dialog-row-offset-timeMax').hide();
                            $('.dialog-row-timeLimits').hide();
                            $('.dialog-row-timeLimits-ph').hide();
                            if ($dialogTimeMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeMaxInput.typedInput('type', types.Undefined.value);
                            }
                            if ($dialogTimeMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeMaxInput.typedInput('type', types.Undefined.value);
                            }
                            _dialogGenHelpText();
                            return;
                        }

                        $dialogTimeRegOperator.show();
                        if (opType === types.TimeEntered.value ||
                            opType === types.TimeSun.value ||
                            opType === types.TimeMoon.value) {
                            $('#dialog-row-offset-timeReg').show();
                        } else {
                            $('#dialog-row-offset-timeReg').hide();
                        }

                        const noLimit = getCheckboxesStr($('#dlg-ip-clktime-rule-timeDays input[type=checkbox]:checked'), 7) === '*' &&
                            getCheckboxesStr($('#dlg-ip-clktime-rule-timeMonths input[type=checkbox]:checked'), 12) === '*' &&
                            $dialogTimeLimitOnlyEvenDays.is(':checked') !== true &&
                            $dialogTimeLimitOnlyOddDays.is(':checked') !== true &&
                            $dialogTimeLimitDateStart.val() === '' &&
                            $dialogTimeLimitDateEnd.val() === '';
                        if (noLimit) {
                            $('.dialog-row-timeLimits').hide();
                            $('.dialog-row-timeLimits-ph').show();
                        } else {
                            $('.dialog-row-timeLimits').show();
                            $('.dialog-row-timeLimits-ph').hide();
                        }
                        getBackendData(d => {
                            // console.log('getBackendData of $dialogTimeRegInput ',d);
                            if (d.value && d.value !== 'none') {
                                const dv = new Date(d.value);
                                dialogAddData.timeReg = {
                                    ts : dv.getTime(),
                                    data : d,
                                    text : bdDateToTime(dv)
                                };
                            } else {
                                dialogAddData.timeReg = {
                                    ts : 0,
                                    data : null,
                                    text : bdDateToTime(d)
                                };
                            }
                            $('#dialog-row-timeReg').attr('title', dialogAddData.timeReg.text);
                            $dialogTimeRegInput.attr('timedata', dialogAddData.timeReg.ts);
                            _dialogGenHelpText();
                        }, {
                            nodeId:         node.id,
                            kind:           'getTimeData',
                            config:         $nodeConfig.val(),
                            type:           opType,
                            value:          $dialogTimeRegInput.typedInput('value'),
                            offsetType:     $dialogTimeRegOffset.typedInput('type'),
                            offset:         $dialogTimeRegOffset.typedInput('value'),
                            multiplier:     parseInt($dialogTimeRegMultiplier.val()),
                            noOffsetError:  true
                        });
                        $dialogTimeMinInput.change();
                        $dialogTimeMaxInput.change();
                    });

                    $dialogTimeMinInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeMin').show();
                            const opType = $dialogTimeMinInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeMin').hide();
                                dialogAddData.timeMin = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeMin').attr('title', dialogAddData.timeMin.text);
                                $dialogTimeMinInput.attr('timedata', dialogAddData.timeMin.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeMin').show();
                            } else {
                                $('#dialog-row-offset-timeMin').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    dialogAddData.timeMin = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    dialogAddData.timeMin = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeMin').attr('title', dialogAddData.timeMin.text);
                                $dialogTimeMinInput.attr('timedata', dialogAddData.timeMin.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeMinInput.typedInput('value'),
                                offsetType:     $dialogTimeMinOffset.typedInput('type'),
                                offset:         $dialogTimeMinOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeMinMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                    });

                    $dialogTimeMaxInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeMax').show();
                            const opType = $dialogTimeMaxInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeMax').hide();
                                dialogAddData.timeMax = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeMax').attr('title', dialogAddData.timeMax.text);
                                $dialogTimeMaxInput.attr('timedata', dialogAddData.timeMax.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeMax').show();
                            } else {
                                $('#dialog-row-offset-timeMax').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    dialogAddData.timeMax = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    dialogAddData.timeMax = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeMax').attr('title', dialogAddData.timeMax.text);
                                $dialogTimeMaxInput.attr('timedata', dialogAddData.timeMax.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeMaxInput.typedInput('value'),
                                offsetType:     $dialogTimeMaxOffset.typedInput('type'),
                                offset:         $dialogTimeMaxOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeMaxMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                    });
                    $('.dialog-row-timeLimits :input').change(() => {
                        if (dialogAddData.timeout2) {
                            clearTimeout(dialogAddData.timeout2);
                            dialogAddData.timeout2 = null;
                        }
                        dialogAddData.timeout2 = setTimeout(() => {
                            dialogAddData.timeout2 = null;
                            $dialogTimeRegInput.change();
                        },1000);
                    });

                    $dialogCondAOperand.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const propType = $dialogCondAOperand.typedInput('type');
                        if (propType === 'none') {
                            $dialogCondAOperator.val(selFields.comparator[0].id);
                            $dialogCondAOperator.hide();
                            $('#dialog-row-condB').hide();

                            $dialogCond2LogOperator.val(0);
                            $('#dialog-row-cond2LogOperator').hide();
                        } else if (propType === 'jsonata' ||
                                   propType === types.PhaseMoon.value ||
                                   propType === types.MsgPayloadByTopic.value) {
                            $dialogCondAOperator.show();
                            $dialogCondAOperator.attr('disabled', true);
                            $dialogCondAOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('#dialog-row-condB').hide();
                            $('#dialog-row-cond2LogOperator').show();
                        } else {
                            $dialogCondAOperator.show();
                            $dialogCondAOperator.attr('disabled', false);
                            const condOp = $dialogCondAOperator.val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('#dialog-row-condB').show();
                            } else {
                                $('#dialog-row-condB').hide();
                            }
                            $('#dialog-row-cond2LogOperator').show();
                        }
                        $dialogCondBOperand.change();
                        $dialogCond2AOperand.change();
                        _dialogGenHelpText();
                    });
                    $dialogCondAOperator.change(() => { $dialogCondAOperand.change(); });

                    $dialogCond2AOperand.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const op2 = parseInt($dialogCond2LogOperator.val());
                        if (isNaN(op2) || op2 === 0) {
                            $dialogCond2AOperator.val(selFields.comparator[0].id);
                            $dialogCond2AOperator.hide();
                            $('#dialog-row-cond2A').hide();
                            $('#dialog-row-cond2B').hide();
                        } else {
                            $dialogCond2AOperator.show();
                            $('#dialog-row-cond2A').show();
                            const propType = $dialogCond2AOperand.typedInput('type');
                            if (propType === 'none') {
                                $dialogCond2AOperator.val(selFields.comparator[0].id);
                                $dialogCond2AOperator.hide();
                                $('#dialog-row-cond2B').hide();
                            } else if (propType === 'jsonata' ||
                                       propType === types.PhaseMoon.value ||
                                       propType === types.MsgPayloadByTopic.value) {
                                $dialogCond2AOperator.show();
                                $dialogCond2AOperator.attr('disabled', true);
                                $dialogCond2AOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                                $('#dialog-row-cond2B').hide();
                            } else {
                                $dialogCond2AOperator.show();
                                $dialogCond2AOperator.attr('disabled', false);
                                const condOp = $dialogCond2AOperator.val();
                                let operatorCount = 1;
                                const fields = selFields.comparator;
                                const fieldsLength = fields.length;
                                for (let index = 0; index < fieldsLength; index++) {
                                    const el = fields[index];
                                    if (el.id === condOp) {
                                        operatorCount = el.operatorCount;
                                        break;
                                    }
                                }
                                if (operatorCount > 1) {
                                    $('#dialog-row-cond2B').show();
                                } else {
                                    $('#dialog-row-cond2B').hide();
                                }

                            }
                        }
                        $dialogCond2BOperand.change();
                        _dialogGenHelpText();
                    });
                    $dialogCond2LogOperator.change(() => { $dialogCond2AOperand.change(); });
                    $dialogCond2AOperator.change(() => { $dialogCond2AOperand.change(); });

                    $dialogPayload.change(() => {
                        const plVType = $dialogPayload.typedInput('type');
                        if (plVType === types.Undefined.value) {
                            $('#dialog-row-topic').hide();
                            $('#dialog-row-payloadTimeFormat').hide();
                            $('#dialog-row-payloadOffset').hide();
                            _dialogGenHelpText();
                            return;
                        } else if (plVType ===  types.TimeEntered.value ||
                            plVType === types.TimeSun.value ||
                            plVType === types.TimeMoon.value ||
                            plVType === types.DateSpecific.value) {
                            $('#dialog-row-topic').show();
                            $('#dialog-row-payloadTimeFormat').show();
                            $('#dialog-row-payloadOffset').show();
                        } else if (plVType ===  types.TimeSunNow.value) {
                            $('#dialog-row-topic').show();
                            $('#dialog-row-payloadTimeFormat').hide();
                            $('#dialog-row-payloadOffset').show();
                        } else {
                            $('#dialog-row-topic').show();
                            $('#dialog-row-payloadTimeFormat').hide();
                            $('#dialog-row-payloadOffset').hide();
                        }
                        getBackendData(d => {
                            const $div = $('#dialog-row-payload');
                            const titleOrg = $div.attr('titleOrg');
                            // $div.attr('title', ((d) ? (String(d) + ' - ') : '') + titleOrg);
                            $div.attr('title', bdDateToTime(d, ' - ') + titleOrg);
                        }, {
                            nodeId:     node.id,
                            kind:       'getOutDataData',
                            config:     $nodeConfig.val(),
                            type:       plVType,
                            value:      $('#dlg-ip-clktime-rule-payload').typedInput('value'),
                            format:     $('#dlg-ip-clktime-rule-payloadTimeFormat').val(),
                            offsetType: $('#dlg-ip-clktime-rule-payloadOffset').typedInput('type'),
                            offset:     $('#dlg-ip-clktime-rule-payloadOffset').typedInput('value'),
                            multiplier: $('#dlg-ip-clktime-rule-payloadOffsetMultiplier').val(),
                            noOffsetError: true
                        });
                        _dialogGenHelpText();
                    });

                    $dialogPayloadTimeFormatsel.on('change focus focusout', (_type, _value) => {
                        if (Number($dialogPayloadTimeFormatsel.val()) === 99) {
                            $dialogPayloadTimeFormatsel.css({ width: '100px' });
                            const width = (205 + 30);
                            $dialogPayloadTimeFormat.css({ width: 'calc(100% - ' + width + 'px)' });
                            $dialogPayloadTimeFormat.show();
                            if (!isNaN($dialogPayloadTimeFormat.val())) {
                                $dialogPayloadTimeFormat.val(node._('node-red-contrib-sun-position/position-config:common.timeFormat.default'));
                            }
                        } else {
                            $dialogPayloadTimeFormat.hide();
                            const width = (100 + 30);
                            $dialogPayloadTimeFormatsel.css({ width: 'calc(100% - ' + width + 'px)' });
                            $dialogPayloadTimeFormat.val($dialogPayloadTimeFormatsel.val());
                        }
                        _dialogGenHelpText();
                    });
                    // #endregion dialogChange
                    // #region dialogload & save

                    /**
                     * generates the help text of the dialog
                     */
                    function _dialogGenHelpText() {
                        $('#dlg-txt-clktimctl-rule-descr').html('');
                        if (dialogAddData.timeout) {
                            clearTimeout(dialogAddData.timeout);
                            dialogAddData.timeout = null;
                        }
                        dialogAddData.timeout = setTimeout(() => {
                            dialogAddData.timeout = null;
                            $('#dlg-txt-clktimctl-rule-descr').html(getRuleDescription(node, selFields, _dialogGetData(), dialogAddData));
                        },1000);
                    }
                    /**
                     * load the data from the rule
                     */
                    function _dialogLoadData(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            $dialogName.val(data.name);
                            dialogDataOnLoading = true;

                            $dialogCondAOperator.val(data.validOperator || selFields.comparator[0].id);
                            setTInputValue($dialogCondAOperand, data.validOperandAValue, data.validOperandAType);
                            setTInputValue($dialogCondBOperand, data.validOperandBValue, data.validOperandBType);

                            $dialogCond2LogOperator.val(data.valid2LogOperator || 0);
                            $dialogCond2AOperator.val(data.valid2Operator || selFields.comparator[0].id);
                            setTInputValue($dialogCond2AOperand, data.valid2OperandAValue, data.valid2OperandAType);
                            setTInputValue($dialogCond2BOperand, data.valid2OperandBValue, data.valid2OperandBType);

                            $dialogTimeRegOperator.val(data.timeOp || 0);
                            $dialogTimeRegMultiplier.val(data.multiplier || 60000);
                            setTInputValue($dialogTimeRegInput, data.timeValue, data.timeType);
                            setTInputValue($dialogTimeRegOffset, data.offsetValue, data.offsetType);

                            initCheckboxesBlock('#dlg-ip-clktime-rule-timeDays', data.timeDays);
                            initCheckboxesBlock('#dlg-ip-clktime-rule-timeMonths', data.timeMonths);
                            $dialogTimeLimitOnlyEvenDays.attr('checked', data.timeOnlyEvenDays);
                            $dialogTimeLimitOnlyOddDays.attr('checked', data.timeOnlyOddDays);

                            if (data.timeDateEnd || data.timeDateStart) {
                                const year = (new Date()).getFullYear();
                                let dStart, dEnd;
                                if (data.timeDateStart) {
                                    dStart = new Date(data.timeDateStart);
                                    dStart.setHours(0, 0, 0, 1);
                                    dStart.setFullYear(year);
                                } else {
                                    dStart = new Date(year, 0, 1, 0, 0, 0, 1);
                                }

                                if (data.timeDateEnd) {
                                    dEnd = new Date(data.timeDateEnd);
                                    dEnd.setHours(23, 59, 59, 999);
                                    dEnd.setFullYear(year);
                                } else {
                                    dEnd = new Date(year, 11, 31, 23, 59, 59, 999);
                                }

                                if (dEnd.getTime() < dStart.getTime()) {
                                    dEnd.setFullYear(year + 1);
                                }
                                const pad = (n, z = 2) => ('00' + n).slice(-z);
                                if (data.timeDateStart) {
                                    $dialogTimeLimitDateStart.val(dStart.getFullYear() + '-' + pad(dStart.getMonth() + 1) + '-' + pad(dStart.getDate()));
                                }
                                if (data.timeDateEnd) {
                                    $dialogTimeLimitDateEnd.val(dEnd.getFullYear() + '-' + pad(dEnd.getMonth() + 1) + '-' + pad(dEnd.getDate()));
                                }
                                $dialogTimeLimitDateStart.change();
                                $dialogTimeLimitDateEnd.change();
                            }

                            $dialogTimeMinMultiplier.val(data.multiplierMin || 60000);
                            setTInputValue($dialogTimeMinInput, data.timeMinValue, data.timeMinType);
                            setTInputValue($dialogTimeMinOffset, data.offsetMinValue, data.offsetMinType);

                            $dialogTimeMaxMultiplier.val(data.multiplierMax || 60000);
                            setTInputValue($dialogTimeMaxInput, data.timeMaxValue, data.timeMaxType);
                            setTInputValue($dialogTimeMaxOffset, data.offsetMaxValue, data.offsetMaxType);

                            $dialogPayloadMultiplier.val(data.payloadOffsetMultiplier || 60000);
                            setTInputValue($dialogPayload, data.payloadValue, data.payloadType);
                            setTInputValue($dialogPayloadOffset, data.payloadOffsetValue, data.payloadOffsetType);
                            const valueNum = Number(data.payloadFormat);
                            if (isNaN(valueNum)) {
                                $dialogPayloadTimeFormatsel.val(99);
                                $dialogPayloadTimeFormat.val(data.payloadFormat);
                            } else {
                                $dialogPayloadTimeFormatsel.val(valueNum);
                            }
                            $dialogTopic.val(data.topic);
                            $dialogImportance.val(data.importance || 0);
                            $dialogResetOverwrite.attr('checked', data.resetOverwrite);

                            _dialogGenHelpText();

                            dialogDataOnLoading = false;
                            $dialogCondAOperand.change();
                            $dialogTimeRegInput.change();
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            $dialogName.val(err.message);
                        }
                        $dialog.dialog('open');
                    }

                    /**
                     * Get the data object for a rule
                     */
                    function _dialogGetData() {
                        const result = {
                            index: dialogDataIndex,
                            name:$dialogName.val(),
                            isValid:true,
                            valid:{},

                            timeValue: $dialogTimeRegInput.typedInput('value'),
                            timeType: $dialogTimeRegInput.typedInput('type'),
                            timeOp: parseInt($dialogTimeRegOperator.val()),
                            timeOpText: $dialogTimeRegOperator.find('option:selected').text(),
                            offsetValue: $dialogTimeRegOffset.typedInput('value'),
                            offsetType: $dialogTimeRegOffset.typedInput('type'),
                            multiplier: parseInt($dialogTimeRegMultiplier.val()),
                            timeDays: getCheckboxesStr($('#dlg-ip-clktime-rule-timeDays input[type=checkbox]:checked'), 7),
                            timeMonths: getCheckboxesStr($('#dlg-ip-clktime-rule-timeMonths input[type=checkbox]:checked'), 12),
                            timeOnlyEvenDays: $dialogTimeLimitOnlyEvenDays.is(':checked'),
                            timeOnlyOddDays: $dialogTimeLimitOnlyOddDays.is(':checked'),
                            timeDateStart: $dialogTimeLimitDateStart.val(),
                            timeDateEnd: $dialogTimeLimitDateEnd.val(),

                            timeMinValue: $dialogTimeMinInput.typedInput('value'),
                            timeMinType: $dialogTimeMinInput.typedInput('type'),
                            offsetMinValue: $dialogTimeMinOffset.typedInput('value'),
                            offsetMinType: $dialogTimeMinOffset.typedInput('type'),
                            multiplierMin: parseInt($dialogTimeMinMultiplier.val()),

                            timeMaxValue: $dialogTimeMaxInput.typedInput('value'),
                            timeMaxType: $dialogTimeMaxInput.typedInput('type'),
                            offsetMaxValue: $dialogTimeMaxOffset.typedInput('value'),
                            offsetMaxType: $dialogTimeMaxOffset.typedInput('type'),
                            multiplierMax:  parseInt($dialogTimeMaxMultiplier.val()),

                            payloadValue: $dialogPayload.typedInput('value'),
                            payloadType: $dialogPayload.typedInput('type'),
                            payloadOffsetValue: $dialogPayloadOffset.typedInput('value'),
                            payloadOffsetType: $dialogPayloadOffset.typedInput('type'),
                            payloadOffsetMultiplier: parseInt($dialogPayloadMultiplier.val()),
                            payloadFormat: $dialogPayloadTimeFormat.val(),
                            topic: $dialogTopic.val(),
                            importance: parseInt($dialogImportance.val()),
                            resetOverwrite: $dialogResetOverwrite.is(':checked'),

                            validOperandAValue: $dialogCondAOperand.typedInput('value'),
                            validOperandAType: $dialogCondAOperand.typedInput('type'),
                            validOperator: $dialogCondAOperator.val(),
                            validOperatorText: $dialogCondAOperator.find('option:selected').text(),
                            validOperandBValue: $dialogCondBOperand.typedInput('value'),
                            validOperandBType: $dialogCondBOperand.typedInput('type'),

                            valid2LogOperator: parseInt($dialogCond2LogOperator.val()),
                            valid2LogOperatorText: $dialogCond2LogOperator.find('option:selected').text(),
                            valid2OperandAValue: $dialogCond2AOperand.typedInput('value'),
                            valid2OperandAType: $dialogCond2AOperand.typedInput('type'),
                            valid2Operator: $dialogCond2AOperator.val(),
                            valid2OperatorText: $dialogCond2AOperator.find('option:selected').text(),
                            valid2OperandBValue: $dialogCond2BOperand.typedInput('value'),
                            valid2OperandBType: $dialogCond2BOperand.typedInput('type')
                        };
                        result.valid.validTimeReg = $dialogTimeRegInput.typedInput('validate');
                        if (result.valid.validTimeReg && result.timeType !== 'none') {
                            result.valid.validTimeReg = $dialogTimeRegOffset.typedInput('validate') &&
                                result.multiplier &&
                                $dialogTimeMinInput.typedInput('validate') &&
                                $dialogTimeMaxInput.typedInput('validate');
                            if (result.valid.validTimeReg && result.timeMinType !== 'none') {
                                result.valid.validTimeReg = $dialogTimeMinOffset.typedInput('validate') &&
                                    result.multiplierMin;
                            }
                            if (result.valid.validTimeReg && result.timeMaxType !== 'none') {
                                result.valid.validTimeReg = $dialogTimeMaxOffset.typedInput('validate') &&
                                    result.multiplierMax;
                            }
                            if (result.timeOnlyEvenDays && result.timeOnlyOddDays) {
                                result.valid.validTimeReg = false;
                            }
                            if (!result.timeDays || !result.timeMonths) {
                                result.valid.validTimeReg = false;
                            }
                        }
                        result.isValid = result.valid.validTimeReg;
                        result.valid.validPayload = $dialogPayload.typedInput('validate');
                        if (result.valid.validPayload && result.payloadType !== 'none') {
                            result.valid.validPayload = $dialogPayloadOffset.typedInput('validate') &&
                                        !isNaN(result.payloadOffsetMultiplier);
                        }
                        result.isValid = result.isValid && result.valid.validPayload;
                        result.valid.validOperand1A = $dialogCondAOperand.typedInput('validate');
                        if (result.validOperandAType !== 'none') {
                            result.valid.validOperand1B = $dialogCondBOperand.typedInput('validate');
                            result.isValid = result.isValid && result.valid.validOperand1B;
                            if (result.valid2LogOperator) {
                                result.valid.validOperand2A = $dialogCond2AOperand.typedInput('validate');
                                result.valid.validOperand2B = $dialogCond2BOperand.typedInput('validate');
                                result.isValid = result.isValid && result.valid.validOperand2A && result.valid.validOperand2B;
                            }
                        }
                        result.isValid = result.isValid && result.valid.validOperand1A;
                        if (!result.isValid) {
                            console.log('rule validation:',result.isValid, result.valid); // eslint-disable-line
                        }

                        return result;
                    }
                    /**
                     * save the data of the rule back
                     */
                    function _dialogSaveData() {
                        const data = _dialogGetData();
                        data.description = getRuleDescription(node, selFields, data);
                        $dialogDataRow.data('ruleData', JSON.stringify(data));
                        $('#rule-name-'+dialogDataIndex).text((data.name || 'rule ' + (dialogDataIndex + 1)) + ((data.importance > 0) ? ' ['+data.importance+']' : ''));
                        $('#rule-description-'+dialogDataIndex).html(data.description);
                        resizeContainer();
                    }

                    /**
                     * Duplicates an existing rule
                     */
                    function _dialogDuplicateRule(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            const nm = parseInt(data.name.match(/[0-9]+(?!.*[0-9])/), 10);
                            if (nm) {
                                data.name = data.name.replace(/[0-9]+(?!.*[0-9])/, nm+1);
                            } else {
                                data.name += ' - copy 1';
                            }
                            data.description = getRuleDescription(node, selFields, data);
                            $('#node-input-rule-container').editableList('addItem', data);
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            $dialogName.val(err.message);
                        }
                    }
                    // #endregion dialogload & save
                    // #endregion dialog
                }; // setup
                $.getScript('sun-position/js/htmlglobal.js')
                    .done((_data, _textStatus,  _bmvfj) => {
                        try {
                            setup(node);
                        } catch (err) {
                            console.log("failed to setup editor"); // eslint-disable-line
                            console.log(err); // eslint-disable-line
                            console.log(err.stack); // eslint-disable-line
                        }
                    })
                    .fail((jqxhr, settings, exception) => {
                        console.log("failed to load htmlglobal.js"); // eslint-disable-line
                        console.log(exception); // eslint-disable-line
                        console.log(exception.stack); // eslint-disable-line
                    });
            },
            oneditsave() {
                const node = this;
                const $rules = $('#node-input-rule-container').editableList('items');
                node.rules = [];
                if ($rules) {
                    $rules.each(function (_i) {
                        const rule = $(this);
                        const data = JSON.parse(rule.data('ruleData'));
                        data.index= _i;
                        node.rules.push(data);
                    });
                }

                const overwriteExpire = parseFloat($('#time-control-overwriteExpire').val());
                if (isNaN(overwriteExpire) || overwriteExpire === '' || overwriteExpire === 0) {
                    $('#node-input-overwriteExpire').val('');
                } else {
                    let val = overwriteExpire * parseFloat($('#time-control-overwriteExpire-multiplier').val());
                    if (val < 1000) {
                        val = 1000;
                    }
                    $('#node-input-overwriteExpire').val(val);
                }

                const autoTriggerTime = parseFloat($('#time-control-autoTriggerTime').val());
                if (isNaN(autoTriggerTime) || autoTriggerTime === '' || autoTriggerTime === 0) {
                    $('#node-input-autoTriggerTime').val(20*60000);
                } else {
                    let val = autoTriggerTime * parseFloat($('#time-control-autoTriggerTime-multiplier').val());
                    if (val < 60000) {
                        val = 60000;
                    }
                    $('#node-input-autoTriggerTime').val(val);
                }

                const startDelayTime = parseFloat($('#time-control-startDelayTime').val());
                if (isNaN(startDelayTime) || startDelayTime === '' || startDelayTime === 0) {
                    $('#node-input-startDelayTime').val(0);
                } else {
                    let val = startDelayTime * parseFloat($('#time-control-startDelayTime-multiplier').val());
                    if (val < 0) {
                        val = 0;
                    }
                    $('#node-input-startDelayTime').val(val);
                }

                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditcancel() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditdelete() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            }
        });
    })();</script>

<script type="text/html" data-template-name="clock-timer">
    <div class="form-row block-noindent is-to-show-initially">
        <span><i class="fa fa-info-circle"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:common.label.infoText" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" class="row-full-width" id="node-input-positionConfig">
    </div>
    <hr>
    <!-- time ######################################################################## -->
    <div class="is-to-show-initially">
        <span><i class="fa fa-list"></i> <span data-i18n="[html]clock-timer.text.time"></span></span></span>
        <div class="form-row node-input-rule-container-row row-full-width">
            <ol id="node-input-rule-container"></ol>
            <button type="button" id="node-button-add" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="clock-timer.label.btnAdd"></span></button> &nbsp;
            <button type="button" id="node-button-clear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="clock-timer.label.btnClear"></span></button> &nbsp;
            <button type="button" id="node-button-sort" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]clock-timer.placeholder.btnSort" style="margin-top: 4px;"><i class="fa fa-sort-amount-asc"></i> <span data-i18n="clock-timer.label.btnSort"></span></button>
        </div>
    </div>
    <div class="form-row block-noindent is-to-show-initially">
        <span data-i18n="[html]clock-timer.text.payloadDefault" class="row-full-width"></span>
    </div>
    <div class="form-row block-noindent is-to-show-initially" id="node-input-payloadDefault-div" data-i18n="[titleOrg]clock-timer.placeholder.payloadDefault">
        <label for="node-input-payloadDefault"><i class="fa fa-envelope"></i> <span data-i18n="clock-timer.label.payloadDefault"></span></label>
        <input type="text" id="node-input-payloadDefault" data-i18n="[placeholder]clock-timer.placeholder.payloadDefault">
        <input type="hidden" id="node-input-payloadDefaultType">
    </div>
    <div class="form-row block-indent1 is-initial-hidden clock-timer-row-payloadDefaultOffset" data-i18n="[title]clock-timer.placeholder.payloadDefaultOffset">
        <label for="node-input-payloadDefaultOffset"><i class="fa fa-calculator"></i> <span data-i18n="clock-timer.label.payloadDefaultOffset"></span></label>
        <input id="node-input-payloadDefaultOffset" data-i18n="[placeholder]clock-timer.placeholder.payloadDefaultOffset">
        <input type="hidden" id="node-input-payloadDefaultOffsetType">
        <select id="node-input-payloadDefaultOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row block-indent1 is-initial-hidden clock-timer-row-payloadDefaultTimeFormat" data-i18n="[title]clock-timer.placeholder.payloadDefaultFormat">
        <label for="node-input-payloadDefaultTimeFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="clock-timer.label.payloadDefaultFormat"></span></label>
        <select id="node-input-payloadDefaultTimeFormatsel">
        </select>
        <input type="text" id="node-input-payloadDefaultTimeFormat">
    </div>
    <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
    </div>
    <hr>
    <!-- overwrite ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
        <span><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]clock-timer.text.overwrite" class="row-full-width"></span></span></span>
    </div>
    <div class="form-row row-overwriteValue block-indent1" data-i18n="[titel]clock-timer.placeholder.overwriteExpire">
        <label for="time-control-overwriteExpire"><i class="fa fa-clock-o"></i> <span data-i18n="clock-timer.label.overwriteExpire"></span></label>
        <input type="text" class="spinner-time" id="time-control-overwriteExpire" data-i18n="[placeholder]clock-timer.placeholder.overwriteExpire" value=""/>
        <select id="time-control-overwriteExpire-multiplier" class="node-input-multiplier">
            <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
            <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
            <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
            <option value="86400000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.4"></option>
        </select>
        <input type="hidden" id="node-input-overwriteExpire">
    </div>
    <hr>
    <!-- Enhanced ######################################################################## -->
    <div class="form-row block-noindent" data-i18n="[title]clock-timer.placeholder.outputs">
        <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="clock-timer.label.outputs"></span></label>
        <select id="node-input-outputs" class="row-full-width">
            <option value="1" data-i18n="clock-timer.label.singleOutput"></option>
            <option value="2" data-i18n="clock-timer.label.splitOutput"></option>
        </select>
    </div>
    <div class="form-row block-noindent spinner-Small" data-i18n="[title]clock-timer.placeholder.autoTrigger">
        <label for="node-input-autoTrigger"><i class="fa fa-clock-o"></i> <span data-i18n="clock-timer.label.autoTrigger"></span></label>
        <input type="checkbox" id="node-input-autoTrigger" style="width: auto;">
        <span id="time-control-autoTriggerTime-edit" class="is-initial-hidden">
            <span data-i18n="clock-timer.label.autoTrigger2"></span>
            <input type="text" class="spinner-time" id="time-control-autoTriggerTime" data-i18n="[placeholder]clock-timer.placeholder.autoTriggerTime" value=""/>
            <select id="time-control-autoTriggerTime-multiplier" class="node-input-multiplier">
                <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
                <option value="86400000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.4"></option>
            </select>
            <input type="hidden" id="node-input-autoTriggerTime">
        </span>
    </div>
    <div class="form-row block-noindent spinner-Small" data-i18n="[title]clock-timer.placeholder.startDelay2">
        <label for="node-input-startDelay"><i class="fa fa-hourglass-start"></i> <span data-i18n="clock-timer.label.startDelay"></span></label>
        <span id="time-control-startDelayTime-edit">
            <input type="text" class="spinner-time" id="time-control-startDelayTime" data-i18n="[placeholder]clock-timer.placeholder.startDelay" value=""/>
            <select id="time-control-startDelayTime-multiplier" class="node-input-multiplier">
                <option value="1" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.0"></option>
                <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
                <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
            </select>
            <input type="hidden" id="node-input-startDelayTime">
        </span>
    </div>
    <hr>
    <!-- End ######################################################################## -->
    <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" class="row-full-width" data-i18n="[placeholder]node-red:common.label.name"/>
    </div>
    <div class="form-tips is-to-show-initially">
        <span data-i18n="[html]clock-timer.tips.documentation" style="word-wrap:break-word;"></span>
    </div>

    <!-- DIALOG ######################################################################## -->
    <div id="dialog-select-context" class="red-ui-editor" title="Select Channel and Datapoint">
        <div id="config-lookup-tree"></div>
    </div>

    <div id="dialog-edit-rule" class="red-ui-editor" title="Edit Rule">
        <div class="dialog-row">
            <label for="dlg-ip-clktime-rule-name"><i class="fa fa-tag"></i> <span data-i18n="clock-timer.label.name"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-name" class="ipalone" data-i18n="[placeholder]clock-timer.placeholder.name">
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-condA">
            <label for="dlg-ip-clktime-rule-condAOperand"><i class="fa fa-puzzle-piece"></i> <span data-i18n="clock-timer.label.ruleCondition"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-condAOperand" class="ipMain" data-i18n="[placeholder]clock-timer.placeholder.condoperand">
            <select id="dlg-ip-clktime-rule-condAOperator" class="ipadd dlg-ip-clktime-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-condB">
            <label for="dlg-ip-clktime-rule-condBOperand"><i class="fa fa-ellipsis-h"></i> <span data-i18n="clock-timer.label.ruleConditionThreshold"></span></label>
            <input id="dlg-ip-clktime-rule-condBOperand" class="ipMain" type="text" data-i18n="[placeholder]clock-timer.placeholder.condoperand">
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-cond2LogOperator">
            <label for="dlg-ip-clktime-rule-cond2LogOperator"><i class="fa fa-puzzle-piece"></i> <span data-i18n="clock-timer.label.ruleAndOr"></span></label>
            <select id="dlg-ip-clktime-rule-cond2LogOperator" class="ipadd dlg-ip-clktime-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-cond2A">
            <label for="dlg-ip-clktime-rule-cond2AOperand"><i class="fa fa-puzzle-piece"></i> <span data-i18n="clock-timer.label.ruleCondition"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-cond2AOperand" class="ipMain" data-i18n="[placeholder]clock-timer.placeholder.condoperand">
            <select id="dlg-ip-clktime-rule-cond2AOperator" class="ipadd dlg-ip-clktime-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-cond2B">
            <label for="dlg-ip-clktime-rule-cond2BOperand"><i class="fa fa-ellipsis-h"></i> <span data-i18n="clock-timer.label.ruleConditionThreshold"></span></label>
            <input id="dlg-ip-clktime-rule-cond2BOperand" class="ipMain" type="text" data-i18n="[placeholder]clock-timer.placeholder.condoperand">
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-timeReg">
            <label for="dlg-ip-clktime-rule-timeReg"><i class="fa fa-clock-o"></i> <span data-i18n="clock-timer.label.time"></span></label>
            <select id="dlg-ip-clktime-rule-timeReg-operator" class="ipadd dlg-ip-clktime-rule-timeReg-operator" >
            </select>
            <input type="text" id="dlg-ip-clktime-rule-timeReg" class="ipMain dlg-ip-clktime-rule-timeReg" value="" data-i18n="[placeholder]clock-timer.placeholder.time">
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeReg">
            <label for="dlg-ip-clktime-rule-offset-timeReg"><i class="fa fa-plus"></i> <span data-i18n="clock-timer.label.offset"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-offset-timeReg"class="ipMain dlg-ip-clktime-rule-offset-timeReg" value="" data-i18n="[placeholder]clock-timer.placeholder.offset">
            <select  id="dlg-ip-clktime-rule-multiplier-timeReg" class="ipadd dlg-ip-clktime-rule-multiplier-timeReg" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeMin">
            <label for="dlg-ip-clktime-rule-timeMin"><i class="fa fa-step-backward" aria-hidden="true"></i> <span data-i18n="clock-timer.label.ruleTimeMin"></span></label>
            <!-- select id="dlg-ip-clktime-rule-timeMax-operator" class="ipadd dlg-ip-clktime-rule-timeMax-operator" >
            </select -->
            <input type="text" id="dlg-ip-clktime-rule-timeMin" class="ipMain dlg-ip-clktime-rule-timeMin" value="" data-i18n="[placeholder]clock-timer.placeholder.time">
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeMin">
            <label for="dlg-ip-clktime-rule-offset-timeMin"><i class="fa fa-plus"></i> <span data-i18n="clock-timer.label.offset-timeMin"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-offset-timeMin"class="ipMain dlg-ip-clktime-rule-offset-timeMin" value="" data-i18n="[placeholder]clock-timer.placeholder.offset">
            <select  id="dlg-ip-clktime-rule-multiplier-timeMin" class="ipadd dlg-ip-clktime-rule-multiplier-timeMin" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeMax">
            <label for="dlg-ip-clktime-rule-timeMax"><i class="fa fa-step-forward" aria-hidden="true"></i> <span data-i18n="clock-timer.label.ruleTimeMax"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-timeMax" class="ipMain dlg-ip-clktime-rule-timeMax" value="" data-i18n="[placeholder]clock-timer.placeholder.time">
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeMax">
            <label for="dlg-ip-clktime-rule-offset-timeMax"><i class="fa fa-plus"></i> <span data-i18n="clock-timer.label.offset-timeMax"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-offset-timeMax"class="ipMain dlg-ip-clktime-rule-offset-timeMax" value="" data-i18n="[placeholder]clock-timer.placeholder.offset">
            <select  id="dlg-ip-clktime-rule-multiplier-timeMax" class="ipadd dlg-ip-clktime-rule-multiplier-timeMax" >
            </select>
        </div>
        <div class="dialog-row dialog-row-timeLimits-ph is-to-show-initially" id="dialog-row-timeConstraintsPlaceholder">
            <div class="dlg-ip-clktime-rule-timecontraintctrl" id="dialog-row-timeConstraints-show">
                <button class="dialog-element-clickable" data-i18n="clock-timer.label.timeconstraintshow"></button>
            </div>
        </div>
        <div class="dialog-row dialog-row-timeLimits is-initial-hidden" id="dialog-row-timeConstraints">
            <div class="dlg-ip-clktime-rule-timecontraintctrl" id="dialog-row-timeConstraints-hide">
                <button class="dialog-element-clickable" data-i18n="clock-timer.label.timeconstrainthide"></button>
            </div>
            <div id="dlg-ip-clktime-rule-timeDays" class="dlg-ip-clktime-rule-days"  data-i18n="[title]clock-timer.placeholder.ruleTimeDays">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="clock-timer.label.validForDays"></div>
                <div style="display:inline-block;">
                    <div>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.8"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.9"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.10"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.11"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.12"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.13"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.7"></span></label>
                    </div>
                </div>
            </div>
            <div class="dlg-ip-clktime-rule-limits" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="clock-timer.label.specialDays"></div>
                <div style="display:inline-block;">
                    <div>
                        <label><input type='checkbox' checked id="dlg-ip-clktime-rule-timeOnlyEvenDays"/> <span data-i18n="clock-timer.label.onlyEven"></span></label>
                        <label><input type='checkbox' checked id="dlg-ip-clktime-rule-timeOnlyOddDays"/> <span data-i18n="clock-timer.label.onlyOdd"></span></label>
                    </div>
                </div>
            </div>
            <div id="dlg-ip-clktime-rule-timeMonths" class="dlg-ip-clktime-rule-months" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="clock-timer.label.validForMonths"></div>
                <div style="display:inline-block;">
                    <div>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.12"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.13"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.14"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.15"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.16"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.17"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.18"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.7"><input type='checkbox' checked value='7'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.19"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.8"><input type='checkbox' checked value='8'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.20"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.9"><input type='checkbox' checked value='9'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.21"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.10"><input type='checkbox' checked value='10'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.22"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.11"><input type='checkbox' checked value='11'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.23"></span></label>
                    </div>
                </div>
            </div>

            <div id="dlg-ip-clktime-rule-timeDateLimit" class="dlg-ip-clktime-rule-datelimit" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;"><i class="fa fa-calendar-o"></i> <span data-i18n="clock-timer.label.validForDates"></span></div>
                <div style="display:inline-block;">
                    <input type="date" id="dlg-ip-clktime-rule-timedatelimit-start" class="ipMain dlg-ip-clktime-rule-timedatelimit" value="" data-i18n="[placeholder]clock-timer.placeholder.start" min="2000-01-01" max="2000-12-31">
                    <input type="date" id="dlg-ip-clktime-rule-timedatelimit-end" class="ipMain dlg-ip-clktime-rule-timedatelimit" value="" data-i18n="[placeholder]clock-timer.placeholder.end" min="2000-01-01" max="2000-12-31">
                </div>
            </div>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-payload" data-i18n="[titleOrg]clock-timer.placeholder.payloadDefault">
            <label for="dlg-ip-clktime-rule-payload"><i class="fa fa-envelope"></i> <span data-i18n="clock-timer.label.payloadDefault"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-payload" class="ipMain" data-i18n="[placeholder]clock-timer.placeholder.payloadDefault">
            <input type="hidden" id="dlg-ip-clktime-rule-payloadType">
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-payloadOffset" data-i18n="[title]clock-timer.placeholder.payloadDefaultOffset">
            <label for="dlg-ip-clktime-rule-payloadOffset"><i class="fa fa-calculator"></i> <span data-i18n="clock-timer.label.payloadDefaultOffset"></span></label>
            <input id="dlg-ip-clktime-rule-payloadOffset" data-i18n="[placeholder]clock-timer.placeholder.payloadDefaultOffset"/>
            <input type="hidden" id="dlg-ip-clktime-rule-payloadOffsetType">
            <select id="dlg-ip-clktime-rule-payloadOffsetMultiplier" class="node-input-multiplier ipadd"></select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-payloadTimeFormat" data-i18n="[title]clock-timer.placeholder.payloadDefaultFormat">
            <label for="dlg-ip-clktime-rule-payloadTimeFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="clock-timer.label.payloadDefaultFormat"></span></label>
            <select id="dlg-ip-clktime-rule-payloadTimeFormatsel" class="ipMain">
            </select>
            <input type="text" id="dlg-ip-clktime-rule-payloadTimeFormat" class="ipadd" />
        </div>
        <div class="dialog-row pt-0" id="dialog-row-resetOverwrite" data-i18n="[title]clock-timer.placeholder.ruleResetOverwrite">
            <label for="dlg-ip-clktime-rule-resetOverwrite"><i class="fa fa-clock-o"></i> <span data-i18n="clock-timer.label.ruleOverwrite"></span></label>
            <input type="checkbox" id="dlg-ip-clktime-rule-resetOverwrite" style="width: auto;">
            <span data-i18n="clock-timer.label.ruleResetOverwrite"></span>
        </div>
        <div class="dialog-row pt-0" id="dialog-row-topic" data-i18n="[title]node-red:common.label.topic" data-i18n="[titleOrg]clock-timer.placeholder.ruleTopic">
            <label for="dlg-ip-clktime-rule-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
            <input type="text" id="dlg-ip-clktime-rule-topic" class="ipMain" data-i18n="[placeholder]node-red:common.label.topic"/>
            <input type="text" id="dlg-ip-clktime-rule-importance" class="ipadd" data-i18n="[placeholder]clock-timer.placeholder.ruleImportance"/>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-descr">
            <label for="dlg-txt-clktimctl-rule-descr" class="pb-1"><i class="fa fa-commenting-o"></i> <span data-i18n="clock-timer.label.ruleDescription" ></span></label>
            <div id="dlg-txt-clktimctl-rule-descr" class="pl-3" style="word-wrap:break-word;"></div>
        </div>
    </div>
</script>
<style>
    hr { width: 100% }
    .mt-0 { margin-top:0 !important; }
    .mb-0 { margin-bottom:0 !important; }
    .mt-1 { margin-top:0.5rem !important; }
    .mb-1 { margin-bottom:0.5rem !important; }
    .pt-0 { padding-top:0 !important; }
    .pb-0 { padding-bottom:0 !important; }
    .pl-0 { padding-left:0 !important; }
    .pr-0 { padding-right:0 !important; }
    .pt-1 { padding-top:0.5rem !important; }
    .pb-1 { padding-bottom:0.5rem !important; }
    .pl-1 { padding-left:0.5rem !important; }
    .pr-1 { padding-right:0.5rem !important; }
    .pt-2 { padding-top:1.0rem !important; }
    .pb-2 { padding-bottom:1.0rem !important; }
    .pl-2 { padding-left:1.0rem !important; }
    .pr-2 { padding-right:1.0rem !important; }
    .pt-3 { padding-top:1.25rem !important; }
    .pb-3 { padding-bottom:1.25rem !important; }
    .pl-3 { padding-left:1.25rem !important; }
    .pr-3 { padding-right:1.25rem !important; }
    .is-to-show-initially { display:none }
    .is-initial-hidden { display:none }
    .form-tips { width: 90% }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 98%
    }
    .block-indent1-noadd {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 98%
    }
    .input-error {
        border-color: #d6615f !important;
        background-color: #ffcccc !important;
        color: #555 !important;
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 96%
    }
    .block-indent2-noadd {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .spinner-Small .ui-spinner {
        width : 100px !important;
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .block-noindent-noadd .ui-spinner {
        width : calc(100% - 110px);
    }
    .block-indent1-noadd .ui-spinner {
        width : calc(100% - 120px);
    }
    .block-indent2-noadd .ui-spinner {
        width : calc(100% - 130px);
    }
    .indent-time-text {
        /* text-indent:10px; */
        padding-left: 20px;
    }
    .indent-enh-text {
        padding-left: 10px;
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
    .ui-spinner input {
        border: none !important;
        width: 95% !important;
    }

    .dialog-row {
        clear: both;
        color: #555;
        margin-bottom: 5px;
    }
    .ui-dialog-rdg .ui-dialog-content-rdg {
        padding: 25px 25px 10px 25px !important;
    }
    .dialog-row label {
        display: inline-block;
        width: 9rem;
        /* width: 25%; */
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 label {
        width: 11rem;
        /*width: 23%; */
    }
    .dialog-row.block-indent2 label {
        width: 13rem;
        /* width: 22%;*/
    }

    .dialog-row .ipalone {
        /* width: calc(90% - 9rem); */
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipMain {
        /* width: calc(60% - 9rem); */
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipadd {
        /* width: calc(20% - 9rem);*/
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ui-spinner {
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-element-clickable {
        user-select: none;
        cursor: pointer;
        touch-action: manipulation;
        display: inline-block;
        /* background: transparent; */
        /* border: 0; */
        vertical-align:top;
        margin-right:5px;
    }
    .dlg-ip-clktime-rule-timecontraintctrl,
    .dlg-ip-clktime-rule-days,
    .dlg-ip-clktime-rule-limits,
    .dlg-ip-clktime-rule-months,
    .dlg-ip-clktime-rule-datelimit {
        margin-top: 5px;
        margin-left: 30%;
    }
    .dlg-ip-clktime-rule-days label,
    .dlg-ip-clktime-rule-months label {
        max-width: 55px;
    }
    .dlg-ip-clktime-rule-days label,
    .dlg-ip-clktime-rule-limits label,
    .dlg-ip-clktime-rule-months label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 110px !important;
    }
    .dlg-ip-clktime-rule-days input,
    .dlg-ip-clktime-rule-limits input,
    .dlg-ip-clktime-rule-months input,
    .dlg-ip-clktime-rule-datelimit input {
        width: auto;
        vertical-align: baseline;
    }
    .dlg-ip-clktime-rule-timedatelimit {
        min-width: 140px;
    }
    .clock-timer-rule-mainblock {
        margin-right: 28px;
    }
    .clock-timer-rule-name-span {
        /* font-weight: bolder; */
        width: 26%; /* width: 120px; */
        float: left;
    }
    .clock-timer-rule-description-span {
        font-size: 10px;
        margin-left: 30%; /* margin-left: 122px; */
        margin-right: 5px;
    }
    .clock-timer-rule-finalspan {
        top: 50%;
        position: absolute;
        right: 66px;
        margin-top: -9px;
    }
    .clock-timer-rule-editBtn,
    .clock-timer-rule-duplicateBtn {
        position: absolute;
        right: 28px;
        margin-top: -9px !important;
    }
    .clock-timer-rule-editBtn {
        top: 25%;
    }
    .clock-timer-rule-duplicateBtn {
        top: 70%;
    }
</style>